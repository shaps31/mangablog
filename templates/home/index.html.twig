{# templates/home/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Accueil{% endblock %}

{% block body %}

    {# Hero immersif #}
    <section class="hero card border-0 shadow-sm p-4 p-lg-5 mb-4 reveal" data-animate="up">
        <div class="row align-items-center g-4">
            <div class="col-lg-7">
                <h1 class="display-5 fw-bold mb-2">Bienvenue sur KamiManga</h1>
                <p class="lead mb-3">
                    Actus, critiques et classements autour du manga.<br class="d-none d-md-inline">
                    <span class="text-muted">D√©couvre, explore, partage le monde du manga ‚ú®</span>
                </p>
                <a href="{{ path('blog_index') }}" class="btn btn-read btn-lg px-4">Voir les derniers articles</a>
            </div>
            <div class="col-lg-5 text-center">
                {# valeur par d√©faut si rien n'est pass√© par le contr√¥leur #}
                {% set _hero   = heroCover|default('img/hero-cover.jpg') %}
                {% set heroSrc = _hero starts with 'http' ? _hero : asset(_hero) %}

                <img src="{{ heroSrc }}" class="img-fluid rounded-4 shadow-sm" alt="Cover hero" loading="lazy">

            </div>

        </div>
    </section>

    {# Cat√©gories populaires en cartes #}
    {% set popularCategories = popularCategories|default([]) %}
    {% if popularCategories|length %}
        {% set icons = {
            'Shonen':'üèÜ', 'Shojo':'üíï', 'Seinen':'‚öîÔ∏è', 'Josei':'üå∏',
            'Isekai / Fantasy':'ü™Ñ', 'Sports':'üèÖ', 'Classiques':'üèõÔ∏è',
            'Nouveaut√©s 2025':'‚ú®', 'Top / Classements':'üìä', 'Adaptations Anime':'üé¨'
        } %}
        <section class="mb-4 reveal" data-animate="left">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h4 fw-bold m-0">Cat√©gories populaires</h2>
                <a class="small text-decoration-none" href="{{ path('blog_index') }}">Tout le blog ‚Üí</a>
            </div>

            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3">
                {% for row in popularCategories %}
                    {% set c = row.category ?? row.c ?? row %}
                    {% set total = row.total ?? row.t ?? 0 %}
                    <div class="col">
                        <a href="{{ path('blog_index', {'category': c.id}) }}" class="card cat-card h-100 text-decoration-none">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="cat-emoji">{{ icons[c.name]|default('üìö') }}</div>
                                <div>
                                    <div class="fw-semibold text-body">{{ c.name }}</div>
                                    <div class="text-muted small">{{ total }} article{{ total>1 ? 's' : '' }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    {# En tendance (carousel) #}
    {% set trending = trending|default([]) %}
    {% if trending|length %}
        <section class="mb-4 reveal" data-animate="right">
            <div class="d-flex justify-content-between align-items-end mb-2">
                <div>
                    <h2 class="h4 fw-bold m-0">En tendance üî•</h2>
                    <p class="text-muted small m-0">Bas√© sur les commentaires approuv√©s r√©cents.</p>
                </div>
                <a class="small text-decoration-none" href="{{ path('blog_index') }}#tendance">Voir plus ‚Üí</a>
            </div>

            <div id="trendCarousel" class="carousel slide" data-bs-ride="false">
                <div class="carousel-inner">
                    {% for chunk in trending|batch(3, null) %}
                        <div class="carousel-item {{ loop.first ? 'active' : '' }}">
                            <div class="row g-3">
                                {% for p in chunk %}
                                    {% if p %}
                                        {% set post = p.post is defined ? p.post : p %}
                                        {% set commentsCount = p.comments is defined
                                            ? p.comments
                                            : (post.comments|filter(c => c.status == 'approved')|length)
                                        %}

                                        <div class="col-12 col-md-4">
                                            <a class="card h-100 text-decoration-none hover-shadow"
                                               href="{{ path('blog_show', {'slug': post.slug}) }}">
                                                <img class="img-cover"
                                                     src="{{ post.cover ?? asset('img/cover-placeholder.png') }}"
                                                     alt="Cover {{ post.title }}" loading="lazy">
                                                <div class="card-body">
                                                    <div class="small text-muted mb-1">
                                                        {{ post.publishedAt ? post.publishedAt|date('Y-m-d') : '‚Äî' }}
                                                        ‚Ä¢ {{ post.category ? post.category.name : '‚Äî' }}
                                                        ‚Ä¢ {{ commentsCount }} com.
                                                    </div>
                                                    <h3 class="h5 card-title">{{ post.title }}</h3>
                                                    <p class="card-text text-muted mb-0">
                                                        {{ post.content|striptags|u.truncate(120, '‚Ä¶') }}
                                                    </p>
                                                </div>
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <button class="carousel-control-prev" type="button"
                        data-bs-target="#trendCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Pr√©c√©dent</span>
                </button>
                <button class="carousel-control-next" type="button"
                        data-bs-target="#trendCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Suivant</span>
                </button>
            </div>
        </section>
    {% endif %}

    {# Citation / slogan #}
    <section class="quote-hero text-center my-5 reveal" data-animate="fade">
        <blockquote class="blockquote m-0">
            <p class="mb-0">¬´ Le manga est un art de vivre. Ici, on le partage. ¬ª</p>
        </blockquote>
    </section>

    {# Nuage de tags (optionnel) #}
    {% set topTags = topTags|default([]) %}
    {% if topTags|length %}
        <section class="mb-4 reveal" data-animate="right">
            <h2 class="h4 fw-bold mb-2">D√©couvrir par tags</h2>
            <div class="tag-cloud">
                {% for row in topTags %}
                    {% set name = row.name ?? row[0] ?? '' %}
                    <a class="badge bg-secondary text-decoration-none me-1 mb-2"
                       href="{{ path('blog_index', {'tag': row.id ?? row.tag_id ?? 0}) }}">#{{ name }}</a>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    {# Derniers articles (optionnel) #}
    {% if latest|default([])|length %}
        <section class="mb-4 reveal" data-animate="up">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h4 fw-bold m-0">Derniers articles</h2>
                <a class="small text-decoration-none" href="{{ path('blog_index') }}">Tout voir ‚Üí</a>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-3">
                {% for p in latest %}
                    <div class="col">
                        <a href="{{ path('blog_show', {slug: p.slug}) }}" class="card h-100 text-decoration-none hover-shadow">
                            <img class="img-cover" src="{{ p.cover ?: asset('img/cover-placeholder.png') }}" alt="" loading="lazy">
                            <div class="card-body">
                                <div class="small text-muted mb-1">
                                    {{ p.category ? p.category.name ~ ' ‚Ä¢ ' : '' }}
                                    {{ p.publishedAt ? p.publishedAt|date('Y-m-d') : '‚Äî' }}
                                </div>
                                <div class="fw-semibold text-body">{{ p.title }}</div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}

{% endblock %}
