{% extends 'base.html.twig' %}
{% block title %}Éditer le profil{% endblock %}

{% block body %}
    <div class="card p-3">
        <h1 class="h4 fw-bold mb-3">Éditer mon profil</h1>

        <div class="d-flex align-items-center gap-3 mb-3">
            {% set avat = app.user.avatarUrl %}
            {% set src = avat ? (avat starts with 'http' ? avat : asset(avat)) : null %}
            {% if src %}
                <img id="avatarPreview" src="{{ src }}" class="avatar-xxl" alt="Avatar">
            {% else %}
                <div id="avatarPreview" class="avatar-xxl avatar-fallback">{{ app.user.initials }}</div>
            {% endif %}
            <div class="text-muted small">Image carrée conseillée (≥ 256×256). PNG/JPG/WEBP.</div>
        </div>

        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}
        <div class="row g-3">
            <div class="col-md-6">{{ form_row(form.firstName) }}</div>
            <div class="col-md-6">{{ form_row(form.lastName) }}</div>
            <div class="col-12">{{ form_row(form.bio) }}</div>
            <div class="col-md-6">{{ form_row(form.avatarUrl) }}</div>
            <div class="col-md-6">{{ form_row(form.avatarFile) }}</div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary">Enregistrer</button>
            <a href="{{ path('app_profile_show') }}" class="btn btn-outline-secondary">Annuler</a>
        </div>
        {{ form_end(form) }}
    </div>

{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        // Aperçu instantané de l’avatar uploadé
        (function(){
            const input = document.querySelector('input[type="file"][name$="[avatarFile]"]');
            const prev  = document.getElementById('avatarPreview');
            if (!input || !prev) return;

            input.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                if (prev.tagName === 'IMG') {
                    prev.src = url;
                } else {
                    // si c’était le fallback lettres, on le remplace par une image
                    const img = document.createElement('img');
                    img.className = prev.className;
                    img.id = prev.id;
                    img.alt = 'Avatar';
                    img.src = url;
                    prev.replaceWith(img);
                }
            });
        })();
    </script>
{% endblock %}
