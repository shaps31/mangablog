{% extends 'base.html.twig' %}
{% block title %}Éditer le profil{% endblock %}

{% block body %}
    <div class="card p-3">
        <h1 class="h4 fw-bold mb-3">Éditer mon profil</h1>

        <div class="d-flex align-items-center gap-3 mb-3">
            {% set avat = app.user.avatarUrl %}
            {% set src = avat ? (avat starts with 'http' ? avat : asset(avat)) : null %}
            {% if src %}
                <img id="avatarPreview" src="{{ src }}" class="avatar-xxl" alt="Avatar">
            {% else %}
                <div id="avatarPreview" class="avatar-xxl avatar-fallback">{{ app.user.initials }}</div>
            {% endif %}
            <div class="text-muted small">Image carrée conseillée (≥ 256×256). PNG/JPG/WEBP.</div>
        </div>

        {{ form_start(form, { attr: { enctype: 'multipart/form-data' } }) }}
        <div class="row g-3">
            <div class="col-md-4 text-center">
                <img src="{{ app.user.avatarOrGravatar }}" class="img-fluid rounded-4 shadow-sm mb-2" alt="Avatar" width="160" height="160">
                {{ form_row(form.avatarFile) }}
                <small class="text-muted d-block">PNG/JPG/WebP • 2 Mo max</small>
            </div>
            <div class="col-md-8">
                {{ form_row(form.firstName) }}
                {{ form_row(form.lastName) }}
                {{ form_row(form.bio) }}
                {{ form_row(form.avatarUrl) }}
                <button class="btn btn-primary mt-2">Enregistrer</button>
            </div>
        </div>
        {{ form_end(form) }}

    </div>

{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        // Aperçu instantané de l’avatar uploadé
        (function(){
            const input = document.querySelector('input[type="file"][name$="[avatarFile]"]');
            const prev  = document.getElementById('avatarPreview');
            if (!input || !prev) return;

            input.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                if (prev.tagName === 'IMG') {
                    prev.src = url;
                } else {
                    // si c’était le fallback lettres, on le remplace par une image
                    const img = document.createElement('img');
                    img.className = prev.className;
                    img.id = prev.id;
                    img.alt = 'Avatar';
                    img.src = url;
                    prev.replaceWith(img);
                }
            });
        })();
    </script>
{% endblock %}
