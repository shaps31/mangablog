{# templates/blog/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ post.title }} ‚Äî MangaBlog{% endblock %}

{% block body %}
    {# ===========================
       Fil d‚ÄôAriane
       =========================== #}
    {% set crumbs = [
        { label: 'Accueil', url: path('app_home') },
        { label: 'Blog',    url: path('blog_index', app.request.query.all) }
    ] %}
    {% if post.category %}
        {% set crumbs = crumbs|merge([{
            label: post.category.name,
            url: path('blog_index', app.request.query.all|merge({'category': post.category.id, 'page': 1}))
        }]) %}
    {% endif %}
    {% set crumbs = crumbs|merge([{ label: post.title }]) %}
    {% include '_partials/_breadcrumb.html.twig' with { items: crumbs } only %}

    {# ===========================
       Article
       =========================== #}
    <article class="bg-white p-4 border rounded mb-4" itemscope itemtype="https://schema.org/Article">
        <header class="mb-3">
            <h1 class="h3 mb-1" itemprop="headline">{{ post.title }}</h1>

            <div class="text-muted small d-flex flex-wrap align-items-center gap-2">
                {# Date #}
                <time datetime="{{ (post.publishedAt ?? 'now')|date('c') }}" itemprop="datePublished">
                    {{ post.publishedAt ? post.publishedAt|date('d/m/Y H:i') : 'Brouillon' }}
                </time>

                {# Auteur (si disponible) #}
                {% if post.author is defined and post.author %}
                    ‚Ä¢ <span itemprop="author">{{ post.author.displayName ?? post.author.userIdentifier }}</span>
                {% endif %}

                {# Lecture estim√©e #}
                {% set words   = post.content|default('')|striptags|replace({'&nbsp;':' '})|split(' ')|length %}
                {% set minutes = (words / 200)|round(0, 'ceil') %}
                ‚Ä¢ ‚è± {{ minutes ?: 1 }} min

                {# Cat√©gorie #}
                {% if post.category %}
                    ‚Ä¢ <a class="link-secondary text-decoration-none"
                         href="{{ path('blog_index', app.request.query.all|merge({'category': post.category.id, 'page': 1})) }}">
                    {{ post.category.name }}
                </a>
                {% endif %}
            </div>

            {# Tags #}
            {% if post.tags|length %}
                <div class="mt-2 d-flex flex-wrap gap-1">
                    {% for t in post.tags %}
                        <a class="badge text-bg-secondary text-decoration-none"
                           href="{{ path('blog_index', app.request.query.all|merge({'tag': t.id, 'page': 1})) }}">
                            {{ t.name }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}

            {# Watchlist #}
            <div class="mt-2">
                {% if app.user %}
                    <form method="post" action="{{ path('watchlist_toggle', {id: post.id}) }}" class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('watchlist' ~ post.id) }}">
                        <button class="btn btn-sm btn-outline-primary">Ajouter √† ma liste</button>
                    </form>
                {% else %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ path('app_login') }}">Ajouter √† ma liste</a>
                {% endif %}
            </div>
        </header>

        {# Cover #}
        {% set coverUrl = post.cover ?: asset('img/cover-placeholder.png') %}
        <img
            src="{{ coverUrl }}"
            class="img-cover mb-3 w-100"
            alt="Couverture : {{ post.title }}"
            loading="lazy"
            decoding="async"
            itemprop="image"
        >

        {# Contenu #}
        <div class="content" style="white-space: pre-line;" itemprop="articleBody">
            {{ post.content }}
        </div>

        {# Partage #}
        {% set pageUrl = absolute_url(path('blog_show', {slug: post.slug})) %}
        <div class="d-flex flex-wrap gap-2 my-3">
            <a class="btn btn-sm btn-outline-secondary"
               href="https://twitter.com/intent/tweet?url={{ pageUrl|url_encode }}&text={{ post.title|url_encode }}"
               target="_blank" rel="noopener">Partager sur X</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="https://www.facebook.com/sharer/sharer.php?u={{ pageUrl|url_encode }}"
               target="_blank" rel="noopener">Facebook</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="https://www.linkedin.com/sharing/share-offsite/?url={{ pageUrl|url_encode }}"
               target="_blank" rel="noopener">LinkedIn</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="mailto:?subject={{ post.title|url_encode }}&body={{ pageUrl|url_encode }}">Email</a>
        </div>

        <div class="mt-3">
            <a href="{{ path('blog_index') }}" class="btn btn-outline-secondary btn-sm">‚Üê Retour au blog</a>
        </div>
    </article>

    {# ===========================
       Articles li√©s
       =========================== #}
    {% set related = related|default([]) %}
    {% if related|length %}
        <h2 class="h6 mt-4">Dans la m√™me cat√©gorie</h2>
        <div class="row row-cols-1 row-cols-md-3 g-3">
            {% for r in related %}
                <div class="col">
                    <a class="text-decoration-none" href="{{ path('blog_show', { slug: r.slug }) }}">
                        <div class="card shadow-sm h-100 reveal" data-animate="up">
                            {% set rCover = r.cover ?: asset('img/cover-placeholder.png') %}
                            <img src="{{ rCover }}" class="card-img-top" alt="Couverture : {{ r.title }}" loading="lazy" decoding="async">
                            <div class="card-body">
                                <div class="small text-muted mb-1">
                                    {{ r.category.name ?? '‚Äî' }} ‚Ä¢ {{ r.publishedAt ? r.publishedAt|date('Y-m-d') : '‚Äî' }}
                                </div>
                                <div class="fw-semibold">{{ r.title }}</div>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# ===========================
       R√©actions
       =========================== #}
    <div id="reactions" class="d-flex gap-2 my-3">
        {% for k,emoji in {'fire':'üî•','lol':'üòÇ','cry':'üò≠','wow':'ü§Ø'} %}
            <button class="btn btn-sm btn-light reaction" data-kind="{{ k }}">{{ emoji }}</button>
        {% endfor %}
    </div>

    {# ===========================
       Commentaires
       =========================== #}
    <h2 class="h5 my-3">Commentaires</h2>

    {% set comments = comments|default([]) %}
    {% if comments is empty %}
        <p class="text-muted">Aucun commentaire approuv√© pour le moment.</p>
    {% else %}
        <div class="vstack gap-3 mb-4">
            {% for c in comments %}
                <div class="p-3 border rounded bg-white">
                    <div class="small text-muted mb-2">
                        {{ c.createdAt|date('Y-m-d H:i') }} ‚Äî
                        {% if c.author %}
                            {{ c.author.displayName ?? c.author.userIdentifier }}
                        {% else %}
                            Anonyme
                        {% endif %}
                    </div>

                    {# Conversion l√©g√®re des balises [spoiler]...[/spoiler] #}
                    {% set txt = c.content|e %}
                    {% set html = txt|replace({'[spoiler]':'<span class="spoiler">','[/spoiler]':'</span>'}) %}
                    <div style="white-space: pre-line">{{ html|raw }}</div>

                    {% if is_granted('ROLE_ADMIN') %}
                        <div class="mt-2">
                            {{ include('comment/_moderate_buttons.html.twig', { comment: c }) }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# ===========================
       Formulaire de commentaire / Reco
       =========================== #}
    {% if app.user and form is defined and form %}
        <div class="bg-white p-3 border rounded">
            <h3 class="h6">Laisser un commentaire</h3>
            {{ form_start(form) }}
            {{ form_row(form.content) }}
            <button class="btn btn-primary btn-sm">Envoyer</button>
            {{ form_end(form) }}
        </div>
    {% else %}
        <div class="alert alert-info">
            Connecte-toi pour commenter :
            <a class="btn btn-sm btn-outline-primary" href="{{ path('app_login') }}">Se connecter</a>
            ou <a class="btn btn-sm btn-outline-secondary" href="{{ path('app_register') }}">Cr√©er un compte</a>
        </div>

        {% set reco = reco|default([]) %}
        {% if reco|length %}
            <h2 class="h6 mt-4">Recommand√© pour vous</h2>
            <div class="row row-cols-1 row-cols-md-3 g-3">
                {% for r in reco %}
                    {% set p = r.post ?? r %}
                    <div class="col">
                        <a class="card h-100 text-decoration-none" href="{{ path('blog_show', {slug: p.slug}) }}">
                            <img class="img-cover" src="{{ p.cover ?: asset('img/cover-placeholder.png') }}" alt="" loading="lazy" decoding="async">
                            <div class="card-body">
                                <div class="fw-semibold">{{ p.title }}</div>
                                <div class="small text-muted">{{ p.publishedAt ? p.publishedAt|date('Y-m-d') : '‚Äî' }}</div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        document.querySelectorAll('.reaction').forEach(btn => {
            btn.addEventListener('click', async () => {
                try {
                    const r = await fetch('{{ path('reaction_toggle', {id: post.id}) }}', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'fetch',
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': '{{ csrf_token('react' ~ post.id) }}'
                        },
                        body: JSON.stringify({ kind: btn.dataset.kind })
                    });
                    if (!r.ok) console.warn('reaction error');
                } catch (e) {
                    console.warn('reaction error', e);
                }
            });
        });
    </script>
{% endblock %}
