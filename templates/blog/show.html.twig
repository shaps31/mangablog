{# templates/blog/show.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ post.title }} — MangaBlog{% endblock %}

{% block body %}
    {# Fil d’Ariane #}
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ path('blog_index') }}">Blog</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ post.title }}</li>
        </ol>
    </nav>

    <article class="bg-white p-4 border rounded mb-4" itemscope itemtype="https://schema.org/Article">
        <header class="mb-3">
            <h1 class="h3 mb-1" itemprop="headline">{{ post.title }}</h1>

            {# métadonnées : date + temps de lecture + catégorie #}
            <div class="text-muted small">
                <time datetime="{{ (post.publishedAt ?? 'now')|date('c') }}" itemprop="datePublished">
                    {{ post.publishedAt ? post.publishedAt|date('d/m/Y H:i') : 'Brouillon' }}
                </time>

                {# ⏱ ~200 mots/minute #}
                {% set words   = post.content|striptags|replace({'&nbsp;':' '})|split(' ')|length %}
                {% set minutes = (words / 200)|round(0, 'ceil') %}
                • ⏱ {{ minutes }} min

                {% if post.category %}
                    •
                    <a class="link-secondary text-decoration-none"
                       href="{{ path('blog_index', app.request.query.all|merge({'category': post.category.id, 'page': 1})) }}">
                        {{ post.category.name }}
                    </a>
                {% endif %}
            </div>

            {# tags cliquables #}
            {% if post.tags|length %}
                <div class="mt-2">
                    {% for t in post.tags %}
                        <a class="badge text-bg-secondary text-decoration-none me-1"
                           href="{{ path('blog_index', app.request.query.all|merge({'tag': t.id, 'page': 1})) }}">
                            {{ t.name }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}
        </header>

        {# cover avec fallback + alt + lazy #}
        {% set coverUrl = post.cover ?: asset('img/cover-placeholder.png') %}
        <figure class="mb-3">
            <img src="{{ coverUrl }}"
                 class="img-fluid rounded"
                 alt="Couverture : {{ post.title }}"
                 loading="lazy"
                 itemprop="image">
        </figure>

        {# contenu : on garde les retours à la ligne saisis dans l’admin #}
        <div class="content" style="white-space: pre-line;" itemprop="articleBody">
            {{ post.content }}
        </div>

        {# Boutons de partage #}
        {% set pageUrl = absolute_url(path('blog_show', {slug: post.slug})) %}
        <div class="d-flex flex-wrap gap-2 my-3">
            <a class="btn btn-sm btn-outline-secondary"
               href="https://twitter.com/intent/tweet?url={{ pageUrl|url_encode }}&text={{ post.title|url_encode }}"
               target="_blank" rel="noopener">Partager sur X</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="https://www.facebook.com/sharer/sharer.php?u={{ pageUrl|url_encode }}"
               target="_blank" rel="noopener">Facebook</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="https://www.linkedin.com/sharing/share-offsite/?url={{ pageUrl|url_encode }}"
               target="_blank" rel="noopener">LinkedIn</a>

            <a class="btn btn-sm btn-outline-secondary"
               href="mailto:?subject={{ post.title|url_encode }}&body={{ pageUrl|url_encode }}">Email</a>
        </div>

        <div class="mt-3">
            <a href="{{ path('blog_index') }}" class="btn btn-outline-secondary btn-sm">← Retour au blog</a>
        </div>
    </article>

    {# Articles liés (même catégorie) #}
    {% if related is defined and related|length %}
        <h2 class="h6 mt-4">Dans la même catégorie</h2>
        <div class="row row-cols-1 row-cols-md-3 g-3">
            {% for r in related %}
                <div class="col">
                    <a class="text-decoration-none" href="{{ path('blog_show', { slug: r.slug }) }}">
                        <div class="card h-100">
                            {% set rCover = r.cover ?: asset('img/cover-placeholder.png') %}
                            <img src="{{ rCover }}" class="card-img-top" alt="Couverture : {{ r.title }}" loading="lazy">
                            <div class="card-body">
                                <div class="small text-muted mb-1">
                                    {{ r.category.name }} • {{ r.publishedAt ? r.publishedAt|date('Y-m-d') : '—' }}
                                </div>
                                <div class="fw-semibold">{{ r.title }}</div>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <h2 class="h5 my-3">Commentaires</h2>

    {% if comments is empty %}
        <p class="text-muted">Aucun commentaire approuvé pour le moment.</p>
    {% else %}
        <div class="vstack gap-3 mb-4">
            {% for c in comments %}
                <div class="p-3 border rounded bg-white">
                    <div class="small text-muted mb-2">
                        {{ c.createdAt|date('Y-m-d H:i') }} — {{ c.author.userIdentifier }}
                    </div>
                    <div style="white-space: pre-line;">{{ c.content }}</div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if app.user and form is defined and form %}
        <div class="bg-white p-3 border rounded">
            <h3 class="h6">Laisser un commentaire</h3>
            {{ form_start(form) }}
            {{ form_row(form.content) }}
            <button class="btn btn-primary btn-sm">Envoyer</button>
            {{ form_end(form) }}
        </div>
    {% else %}
        <div class="alert alert-info">
            Connecte-toi pour commenter :
            <a class="btn btn-sm btn-outline-primary" href="{{ path('app_login') }}">Se connecter</a>
            ou <a class="btn btn-sm btn-outline-secondary" href="{{ path('app_register') }}">Créer un compte</a>
        </div>
    {% endif %}
{% endblock %}
